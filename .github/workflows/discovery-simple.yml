name: Discovery Simple Generation

on:
  workflow_dispatch:
    inputs:
      date:
        description: 'Date to process (YYYY-MM-DD)'
        required: false
        default: ''

jobs:
  discovery-simple:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        cd holler-discovery
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
    
    - name: Set date variable
      id: date
      run: |
        if [ -n "${{ github.event.inputs.date }}" ]; then
          echo "date=${{ github.event.inputs.date }}" >> $GITHUB_OUTPUT
        else
          echo "date=$(date -u +%F)" >> $GITHUB_OUTPUT
        fi
    
    - name: Create test discovery content
      env:
        DATABASE_URL: ${{ secrets.RAILWAY_DATABASE_URL }}
        DISCOVERY_DATE: ${{ steps.date.outputs.date }}
      run: |
        # Create discovery directory
        mkdir -p client/build/discover/$DISCOVERY_DATE
        
        # Create index page using echo
        echo "<!DOCTYPE html>" > client/build/discover/$DISCOVERY_DATE/index.html
        echo "<html lang=\"en\">" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "<head>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "    <meta charset=\"UTF-8\">" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "    <title>$DISCOVERY_DATE - Discovery Feed by Holler.News</title>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "    <meta name=\"description\" content=\"Discovery feed for $DISCOVERY_DATE with curated URLs.\">" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "    <meta name=\"robots\" content=\"index, follow\">" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "    <link rel=\"canonical\" href=\"https://holler.news/discover/$DISCOVERY_DATE/\">" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "    <style>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f8f9fa; color: #333; }" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "        .header { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "        .intro { margin-bottom: 20px; color: #666; }" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "        .stats { background: #e3f2fd; padding: 15px; border-radius: 6px; margin-bottom: 20px; }" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "    </style>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "</head>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "<body>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "    <div class=\"header\">" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "        <h1>Discovery Feed by Holler.News</h1>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "        <div class=\"intro\">" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "            <p>Discovery feed for <strong>$DISCOVERY_DATE</strong>. This page contains curated URLs discovered by our automated system.</p>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "            <p>Each link has been filtered for quality and relevance, removing parking pages and spam while highlighting documents, reports, and substantive content.</p>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "        </div>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "        <div class=\"stats\">" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "            <strong>Daily Statistics:</strong><br>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "            • Test URLs discovered<br>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "            • 1 pages of content<br>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "            • Content from test sources" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "        </div>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "    </div>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "    <div class=\"page-list\">" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "        <h2>Available Pages</h2>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "        <div class=\"page-item\">" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "            <a href=\"https://holler.news/discover/$DISCOVERY_DATE/page-000001.html\">" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "                <span class=\"page-number\">Page 1</span>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "            </a>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "            <span class=\"page-stats\">Test Links 1-5</span>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "        </div>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "    </div>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "    <div class=\"navigation\">" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "        <a href=\"https://holler.news/\">Home</a> | " >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "        <a href=\"https://holler.news/sitemap-index.xml\">Sitemap</a>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "    </div>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "</body>" >> client/build/discover/$DISCOVERY_DATE/index.html
        echo "</html>" >> client/build/discover/$DISCOVERY_DATE/index.html
        
        # Create page 1 using echo
        echo "<!DOCTYPE html>" > client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "<html lang=\"en\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "<head>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "    <meta charset=\"UTF-8\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "    <title>Page 1 - $DISCOVERY_DATE - Discovery Feed by Holler.News</title>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "    <meta name=\"description\" content=\"Discover 5 interesting URLs from $DISCOVERY_DATE, including pages from various sources.\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "    <meta name=\"robots\" content=\"index, follow\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "    <link rel=\"canonical\" href=\"https://holler.news/discover/$DISCOVERY_DATE/page-000001.html\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "    <style>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f8f9fa; color: #333; }" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        .header { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        .intro { margin-bottom: 20px; color: #666; }" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        .url-list { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        .url-item { margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #eee; }" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        .url-link { color: #0066cc; text-decoration: none; font-weight: 500; }" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        .url-link:hover { text-decoration: underline; }" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        .url-host { font-weight: 600; color: #333; }" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        .url-path { color: #666; }" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        .source-badge { display: inline-block; background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-left: 8px; }" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        .navigation { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        .nav-link { display: inline-block; padding: 8px 16px; margin: 0 8px; background: #0066cc; color: white; text-decoration: none; border-radius: 4px; }" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        .nav-link:hover { background: #0052a3; }" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        .nav-link.disabled { background: #ccc; cursor: not-allowed; }" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "    </style>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "</head>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "<body>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "    <div class=\"header\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        <h1>Discovery Feed by Holler.News</h1>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        <div class=\"intro\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "            <p>Discovering interesting URLs from across the web on $DISCOVERY_DATE. This page contains 5 curated links, including content from various sources.</p>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "            <p>Each link has been filtered for quality and relevance, removing parking pages and spam while highlighting documents, reports, and substantive content.</p>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        </div>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        <div class=\"page-info\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "            Page 1 of 1 | Links 1-5" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        </div>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "    </div>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "    <div class=\"url-list\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        <h2>Discovered URLs</h2>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        <ul style=\"list-style: none; padding: 0;\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "            <li class=\"url-item\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                <a href=\"https://example.com/research/paper.pdf\" class=\"url-link\" target=\"_blank\" rel=\"noopener noreferrer\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                    <span class=\"url-host\">example.com</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                    <span class=\"url-path\">/research/paper.pdf</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                </a>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                <span class=\"source-badge\">Source: CC</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "            </li>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "            <li class=\"url-item\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                <a href=\"https://news.example.com/breaking-story\" class=\"url-link\" target=\"_blank\" rel=\"noopener noreferrer\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                    <span class=\"url-host\">news.example.com</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                    <span class=\"url-path\">/breaking-story</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                </a>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                <span class=\"source-badge\">Source: RSS</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "            </li>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "            <li class=\"url-item\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                <a href=\"https://research.example.com/study\" class=\"url-link\" target=\"_blank\" rel=\"noopener noreferrer\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                    <span class=\"url-host\">research.example.com</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                    <span class=\"url-path\">/study</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                </a>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                <span class=\"source-badge\">Source: CT</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "            </li>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "            <li class=\"url-item\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                <a href=\"https://docs.example.com/guide.pdf\" class=\"url-link\" target=\"_blank\" rel=\"noopener noreferrer\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                    <span class=\"url-host\">docs.example.com</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                    <span class=\"url-path\">/guide.pdf</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                </a>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                <span class=\"source-badge\">Source: CC</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "            </li>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "            <li class=\"url-item\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                <a href=\"https://blog.example.com/insights\" class=\"url-link\" target=\"_blank\" rel=\"noopener noreferrer\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                    <span class=\"url-host\">blog.example.com</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                    <span class=\"url-path\">/insights</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                </a>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "                <span class=\"source-badge\">Source: RSS</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "            </li>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        </ul>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "    </div>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "    <div class=\"navigation\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        <div class=\"page-info\">" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "            Page 1 of 1 for $DISCOVERY_DATE" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        </div>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        <span class=\"nav-link disabled\">← Previous Page</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        <a href=\"https://holler.news/discover/$DISCOVERY_DATE/\" class=\"nav-link\">Day Index</a>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "        <span class=\"nav-link disabled\">Next Page →</span>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "    </div>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "</body>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        echo "</html>" >> client/build/discover/$DISCOVERY_DATE/page-000001.html
        
        echo "Created test discovery files for $DISCOVERY_DATE"
        echo "Files created:"
        ls -la client/build/discover/$DISCOVERY_DATE/
    
    - name: Create test sitemap
      env:
        DISCOVERY_DATE: ${{ steps.date.outputs.date }}
      run: |
        # Create sitemaps directory
        mkdir -p client/build/sitemaps
        
        # Create sitemap for the date using echo
        echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>" > client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml
        echo "<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">" >> client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml
        echo "  <url>" >> client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml
        echo "    <loc>https://holler.news/discover/$DISCOVERY_DATE/</loc>" >> client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml
        echo "    <lastmod>$DISCOVERY_DATE"T00:00:00Z"</lastmod>" >> client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml
        echo "    <changefreq>daily</changefreq>" >> client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml
        echo "    <priority>0.8</priority>" >> client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml
        echo "  </url>" >> client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml
        echo "  <url>" >> client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml
        echo "    <loc>https://holler.news/discover/$DISCOVERY_DATE/page-000001.html</loc>" >> client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml
        echo "    <lastmod>$DISCOVERY_DATE"T00:00:00Z"</lastmod>" >> client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml
        echo "    <changefreq>daily</changefreq>" >> client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml
        echo "    <priority>0.7</priority>" >> client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml
        echo "  </url>" >> client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml
        echo "</urlset>" >> client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml
        
        # Create sitemap index using echo
        echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>" > client/build/sitemap-index.xml
        echo "<sitemapindex xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">" >> client/build/sitemap-index.xml
        echo "  <sitemap>" >> client/build/sitemap-index.xml
        echo "    <loc>https://holler.news/sitemaps/sitemap-$DISCOVERY_DATE.xml</loc>" >> client/build/sitemap-index.xml
        echo "    <lastmod>$DISCOVERY_DATE"T00:00:00Z"</lastmod>" >> client/build/sitemap-index.xml
        echo "  </sitemap>" >> client/build/sitemap-index.xml
        echo "</sitemapindex>" >> client/build/sitemap-index.xml
        
        echo "Created sitemap files for $DISCOVERY_DATE"
        echo "Sitemap: client/build/sitemaps/sitemap-$DISCOVERY_DATE.xml"
        echo "Index: client/build/sitemap-index.xml"
    
    - name: Commit and push changes
      env:
        DISCOVERY_DATE: ${{ steps.date.outputs.date }}
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add client/build/discover/ client/build/sitemaps/ client/build/sitemap-index.xml
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update discovery feed - $DISCOVERY_DATE"
          git push origin main
          echo "Changes committed and pushed successfully"
        fi